# Git Komet - Backend

Backend сервис для системы автооценки эффективности команд через анализ Git-метрик.

## Технологии

- **Python 3.8+**
- **FastAPI** - современный веб-фреймворк для создания API
- **SQLAlchemy** - ORM для работы с базой данных
- **SQLite** - база данных (легко заменяется на PostgreSQL/MySQL)
- **Pydantic** - валидация данных

## Структура проекта

```
backend/
├── app/
│   ├── api/              # API endpoints
│   │   ├── projects.py   # Управление проектами
│   │   ├── pull_requests.py  # Pull Requests
│   │   ├── issues.py     # Задачи/Issues
│   │   ├── metrics.py    # Метрики и анализ
│   │   └── mock.py       # Генерация моковых данных
│   ├── models/           # Модели данных
│   │   ├── database_models.py  # SQLAlchemy модели
│   │   └── schemas.py    # Pydantic схемы
│   ├── services/         # Бизнес-логика
│   │   └── bottleneck_service.py  # Анализ узких мест
│   ├── database/         # Конфигурация БД
│   │   └── connection.py # Подключение к БД
│   ├── mock_data/        # Генераторы моковых данных
│   │   └── generator.py  # Генерация тестовых данных
│   └── main.py           # Главное приложение FastAPI
├── requirements.txt      # Зависимости Python
└── README.md            # Данный файл
```

## Установка и запуск

### 1. Установка зависимостей

```bash
cd backend
pip install -r requirements.txt
```

### 2. Запуск сервера

```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

Сервер запустится на `http://localhost:8000`

### 3. Документация API

После запуска доступна интерактивная документация:
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

## Использование

### Генерация тестовых данных

Для демонстрации функционала используйте endpoint генерации моковых данных:

```bash
curl -X POST http://localhost:8000/mock/generate
```

Это создаст демо-проект с 20 Pull Requests и 30 задачами.

### Анализ узких мест

После генерации данных можно запросить анализ узких мест:

```bash
curl http://localhost:8000/metrics/bottlenecks/1
```

Где `1` - это ID проекта (обычно первый созданный проект имеет ID = 1).

### Основные endpoints

- `GET /` - Информация об API
- `GET /health` - Проверка здоровья сервиса
- `POST /projects/` - Создание проекта
- `GET /projects/` - Список проектов
- `GET /projects/{project_id}` - Информация о проекте
- `POST /pull-requests/` - Создание Pull Request
- `GET /pull-requests/project/{project_id}` - Pull Requests проекта
- `POST /issues/` - Создание задачи
- `GET /issues/project/{project_id}` - Задачи проекта
- `GET /metrics/bottlenecks/{project_id}` - Анализ узких мест проекта
- `GET /metrics/project/{project_id}` - История метрик проекта
- `POST /mock/generate` - Генерация тестовых данных
- `DELETE /mock/clear` - Удаление всех данных

## Ключевые возможности

### 1. Анализ узких мест

Система автоматически вычисляет и анализирует:

- **Для Pull Requests:**
  - Среднее время до первого ревью
  - Среднее время до одобрения
  - Среднее время до мерджа

- **Для задач:**
  - Среднее время до начала работы
  - Среднее время выполнения

### 2. Обнаружение проблем

На основе пороговых значений система определяет узкие места:
- PR ожидает первое ревью > 24 часов
- PR ожидает одобрения > 48 часов
- PR не мерджится > 72 часов
- Задача не берётся в работу > 48 часов
- Задача выполняется > 168 часов (неделя)

### 3. Рекомендации

Для каждого обнаруженного узкого места система предлагает рекомендации по улучшению процесса.

## Архитектура и дизайн

### Независимость от источника данных

Система спроектирована так, чтобы быть независимой от источника данных:

1. **API принимает стандартизированные модели** - PullRequestCreate, IssueCreate и т.д.
2. **Данные могут приходить откуда угодно:**
   - Из моков (текущая реализация)
   - Из внешних API (GitLab, GitHub, Bitbucket)
   - Из webhooks
   - Из файлов импорта

3. **Бизнес-логика не зависит от источника** - BottleneckService работает с данными из БД, не зная откуда они пришли.

### Масштабируемость

- Легко добавить новые метрики через расширение BottleneckService
- Легко добавить новые источники данных через создание новых endpoints
- База данных SQLite легко заменяется на PostgreSQL/MySQL через изменение строки подключения

## TODO (будущие улучшения)

Следующие функции запланированы для реализации:

- [ ] **Отслеживание TODO в коде** - интеграция с анализом кода для обнаружения роста TODO
- [ ] **Индикаторы заботы о сотрудниках** - анализ активности вне рабочего времени, переработки
- [ ] **Метрики качества кода:**
  - [ ] Code churn (переписывание кода)
  - [ ] Покрытие тестами
  - [ ] Статический анализ кода
- [ ] **Общая оценка проекта** - агрегированный показатель эффективности
- [ ] **Тренды** - отслеживание изменений метрик во времени
- [ ] **Интеграция с Т1 Сфера.Код**
- [ ] **Метрики для команд и персональные метрики**
- [ ] **Уведомления** - алерты о критических узких местах
- [ ] **Экспорт отчётов** - PDF, Excel
- [ ] **Настраиваемые пороги** - возможность задавать свои пороговые значения

## Разработка

### Запуск в режиме разработки

```bash
uvicorn app.main:app --reload
```

Флаг `--reload` включает автоматическую перезагрузку при изменении кода.

### База данных

При первом запуске автоматически создаётся файл `git_komet.db` с таблицами:
- `projects` - проекты
- `pull_requests` - Pull Requests
- `issues` - задачи
- `metrics` - вычисленные метрики

Для сброса БД достаточно удалить файл `git_komet.db` и перезапустить сервер.
