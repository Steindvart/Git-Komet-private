<template>
  <div>
    <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Git-Komet</h1>
    <p class="subtitle">–£–º–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ Git-–º–µ—Ç—Ä–∏–∫</p>
    
    <!-- Project Selector -->
    <div class="project-selector">
      <label for="project-select">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:</label>
      <select 
        id="project-select" 
        v-model="selectedProjectId" 
        @change="onProjectChange"
        :disabled="loading"
      >
        <option :value="null">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç --</option>
        <option v-for="project in projects" :key="project.id" :value="project.id">
          {{ project.name }}
        </option>
      </select>
    </div>
    
    <div class="dashboard-grid">
      <div class="card">
        <h3>üìä –û–±–∑–æ—Ä</h3>
        <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ Git-–º–µ—Ç—Ä–∏–∫–∏:</p>
        <ul class="feature-list">
          <li>‚úì –û—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥ (0-100)</li>
          <li>‚úì –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–ª–≥–∞</li>
          <li>‚úì –í—ã—è–≤–ª–µ–Ω–∏–µ —É–∑–∫–∏—Ö –º–µ—Å—Ç</li>
          <li>‚úì –ó–∞–±–æ—Ç–∞ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö (–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏)</li>
          <li>‚úì –ê–ª–µ—Ä—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</li>
        </ul>
      </div>

      <div class="card" v-if="selectedProjectId && projectMetrics">
        <h3>üéØ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</h3>
        <div class="stats">
          <div class="stat-item">
            <span class="stat-label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
            <span class="stat-value">{{ projectMetrics.effectiveness_score }}/100</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">–ö–æ–º–º–∏—Ç—ã</span>
            <span class="stat-value">{{ projectMetrics.total_commits }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">PR</span>
            <span class="stat-value">{{ projectMetrics.total_prs }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">–£—á–∞—Å—Ç–Ω–∏–∫–∏</span>
            <span class="stat-value">{{ projectMetrics.active_contributors }}</span>
          </div>
        </div>
        <div v-if="projectMetrics.has_alert" class="alert" :class="`alert-${projectMetrics.alert_severity}`">
          <strong>{{ projectMetrics.alert_severity === 'critical' ? 'üö®' : '‚ö†Ô∏è' }}</strong>
          {{ projectMetrics.alert_message }}
        </div>
      </div>
      
      <div class="card" v-else-if="!selectedProjectId">
        <h3>üéØ –ù–∞—á–Ω–∏—Ç–µ —Ä–∞–±–æ—Ç—É</h3>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –º–µ—Ç—Ä–∏–∫</p>
        <p style="margin-top: 1rem; color: var(--text-secondary);">–í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: {{ projects.length }}</p>
      </div>

      <div class="card">
        <h3>üöÄ –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        <div class="actions">
          <NuxtLink to="/repositories" class="btn btn-primary">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏
          </NuxtLink>
          <NuxtLink to="/metrics" class="btn btn-secondary" v-if="selectedProjectId">
            –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
          </NuxtLink>
        </div>
      </div>

      <div class="card">
        <h3>üîç –¢–∏–ø—ã –∞–Ω–∞–ª–∏–∑–∞</h3>
        <div class="analysis-types">
          <div class="analysis-item">
            <span class="analysis-icon">üìä</span>
            <div class="analysis-info">
              <strong>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã</strong>
              <p>–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å —Ç—Ä–µ–Ω–¥–∞–º–∏ –∏ –∞–ª–µ—Ä—Ç–∞–º–∏</p>
            </div>
          </div>
          <div class="analysis-item">
            <span class="analysis-icon">üîß</span>
            <div class="analysis-info">
              <strong>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥</strong>
              <p>–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏, —Ä–æ—Å—Ç TODO, –∫–∞—á–µ—Å—Ç–≤–æ —Ä–µ–≤—å—é, code churn</p>
            </div>
          </div>
          <div class="analysis-item">
            <span class="analysis-icon">üöß</span>
            <div class="analysis-info">
              <strong>–£–∑–∫–∏–µ –º–µ—Å—Ç–∞</strong>
              <p>–í—ã—è–≤–ª–µ–Ω–∏–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–π –≤ workflow –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</p>
            </div>
          </div>
          <div class="analysis-item">
            <span class="analysis-icon">üíº</span>
            <div class="analysis-info">
              <strong>–ó–∞–±–æ—Ç–∞ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö</strong>
              <p>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–æ–∫ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤–Ω–µ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</p>
            </div>
          </div>
        </div>
      </div>

      <div class="card full-width">
        <h3>üí° –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã</h3>
        <div class="getting-started">
          <div class="step">
            <span class="step-number">1</span>
            <div class="step-content">
              <strong>–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–µ–∫—Ç</strong>
              <p>–î–æ–±–∞–≤—å—Ç–µ Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>
            </div>
          </div>
          <div class="step">
            <span class="step-number">2</span>
            <div class="step-content">
              <strong>–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—É</strong>
              <p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–º–∞–Ω–¥—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –¥–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
            </div>
          </div>
          <div class="step">
            <span class="step-number">3</span>
            <div class="step-content">
              <strong>–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ</strong>
              <p>–°–∏–º—É–ª–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ (–∫–æ–º–º–∏—Ç—ã, PR, —Ä–µ–≤—å—é, –∑–∞–¥–∞—á–∏)</p>
            </div>
          </div>
          <div class="step">
            <span class="step-number">4</span>
            <div class="step-content">
              <strong>–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∞–Ω–∞–ª–∏—Ç–∏–∫—É</strong>
              <p>–ò–∑—É—á–∞–π—Ç–µ –º–µ—Ç—Ä–∏–∫–∏, —Ç—Ä–µ–Ω–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
const api = useApi()
const projects = ref([])
const selectedProjectId = ref<number | null>(null)
const projectMetrics = ref<any>(null)
const loading = ref(false)

onMounted(async () => {
  await loadProjects()
})

const loadProjects = async () => {
  loading.value = true
  try {
    projects.value = await api.fetchProjects()
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å
    if (projects.value.length > 0) {
      selectedProjectId.value = projects.value[0].id
      await loadProjectMetrics()
    }
  } catch (error) {
    console.error('Error loading projects:', error)
  } finally {
    loading.value = false
  }
}

const onProjectChange = async () => {
  if (selectedProjectId.value) {
    await loadProjectMetrics()
  } else {
    projectMetrics.value = null
  }
}

const loadProjectMetrics = async () => {
  if (!selectedProjectId.value) return
  
  loading.value = true
  try {
    projectMetrics.value = await api.fetchProjectMetrics(selectedProjectId.value)
  } catch (error) {
    console.error('Error loading project metrics:', error)
  } finally {
    loading.value = false
  }
}
</script>

<style scoped>
.subtitle {
  color: var(--text-secondary);
  font-size: 1.125rem;
  margin-bottom: 1.5rem;
}

.project-selector {
  margin-bottom: 2rem;
  padding: 1.5rem;
  background-color: var(--bg-secondary);
  border-radius: 0.5rem;
  border: 1px solid var(--border-primary);
}

.project-selector label {
  display: block;
  margin-bottom: 0.75rem;
  font-weight: 600;
  color: var(--text-primary);
}

.project-selector select {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border-primary);
  border-radius: 0.375rem;
  background-color: var(--bg-primary);
  color: var(--text-primary);
  font-size: 1rem;
  cursor: pointer;
}

.project-selector select:focus {
  outline: none;
  border-color: var(--accent-primary);
}

.project-selector select:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.alert {
  margin-top: 1rem;
  padding: 1rem;
  border-radius: 0.5rem;
}

.alert-warning {
  background-color: rgba(210, 153, 34, 0.15);
  border-left: 4px solid var(--warning);
  color: var(--text-primary);
}

.alert-critical {
  background-color: rgba(248, 81, 73, 0.15);
  border-left: 4px solid var(--danger);
  color: var(--text-primary);
}

.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
  margin-top: 2rem;
}

.full-width {
  grid-column: 1 / -1;
}

.stats {
  display: flex;
  gap: 2rem;
  margin-top: 1rem;
}

.stat-item {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.stat-label {
  font-size: 0.875rem;
  color: var(--text-secondary);
  font-weight: 500;
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--accent-primary);
}

.actions {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-top: 1rem;
}

.feature-list {
  list-style: none;
  padding: 0;
  margin-top: 1rem;
}

.feature-list li {
  padding: 0.5rem 0;
  color: var(--text-secondary);
}

.analysis-types {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-top: 1rem;
}

.analysis-item {
  display: flex;
  gap: 1rem;
  padding: 1rem;
  background-color: var(--bg-tertiary);
  border-radius: 0.5rem;
  border: 1px solid var(--border-primary);
}

.analysis-icon {
  font-size: 2rem;
}

.analysis-info strong {
  display: block;
  color: var(--text-primary);
  margin-bottom: 0.25rem;
}

.analysis-info p {
  color: var(--text-secondary);
  font-size: 0.875rem;
  margin: 0;
}

.getting-started {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-top: 1rem;
}

.step {
  display: flex;
  gap: 1rem;
  padding: 1rem;
  background-color: var(--bg-tertiary);
  border-radius: 0.5rem;
  border: 1px solid var(--border-primary);
}

.step-number {
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  background-color: var(--accent-secondary);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  flex-shrink: 0;
}

.step-content strong {
  display: block;
  color: var(--text-primary);
  margin-bottom: 0.25rem;
}

.step-content p {
  color: var(--text-secondary);
  font-size: 0.875rem;
  margin: 0;
}
</style>
